<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>d3rty/json WASM Demo</title>

    <!-- HTMX v2 -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        textarea { width: 100%; font-family: monospace; margin: 0.5rem 0; }
        pre { background: #f4f4f4; padding: 1rem; overflow-x: auto; }
        button { padding: 0.5rem 1rem; }
        label { display: block; margin-top: 1rem; }
        code { display: block; white-space: pre; font-family: monospace; }
    </style>
</head>
<body>

<h1>d3rty/json WASM Demo</h1>
<p>Below is the fixed model we’ll unmarshal into:</p>
<pre><code>type Event struct {
    dirty.Enabled
    Name     string <span style="color: #0a0;">&#96;json:"name"&#96;</span>
    ID       int    <span style="color: #0a0;">&#96;json:"id"&#96;</span>
    IsActive bool   <span style="color: #0a0;">&#96;json:"is_active"&#96;</span>
    MustBool bool   <span style="color: #0a0;">&#96;json:"must_bool"&#96;</span>
}</code></pre>

<form id="cleaner"
      hx-post="/clean"
      hx-target="#output"
      hx-swap="innerHTML"
      onsubmit="return false;">
    <label>
        <strong>Dirty JSON</strong><br>
        <textarea name="json" rows="8">{
  "id": "2.5e6",
  "Is_Active": "yes",
  "must_bool": 1,
  "Name": "hello World"
}</textarea>
    </label>
    <button type="submit">Clean it →</button>
</form>

<h2>Clean JSON</h2>
<pre id="output">{ … result appears here … }</pre>

<!-- Go WASM runtime -->
<script src="wasm_exec.js"></script>
<script>
	const go = new Go();
	WebAssembly
		.instantiateStreaming(fetch("main.wasm"), go.importObject)
		.then(res => go.run(res.instance))
		.catch(console.error);
</script>

<!-- HTMX listener to call our WASM function instead of doing a network request -->
<script>
	document.body.addEventListener('htmx:beforeRequest', event => {
		const form = event.detail.elt;
		if (form.id !== 'cleaner') return;

		// prevent the dummy POST
		event.preventDefault();

		// grab the JSON input
		const jsonRaw = form.querySelector('[name=json]').value;

		// call the WASM-exported function
		let out;
		try {
			out = cleanJSON(jsonRaw);
		} catch (err) {
			out = JSON.stringify({ error: err.toString() }, null, 2);
		}

		// inject into the <pre id="output">
		document.getElementById('output').textContent = out;
	});
</script>

</body>
</html>