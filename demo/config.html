<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Form</title>
    <!-- Bootstrap CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
    <!-- Tagify CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css"
            rel="stylesheet"
    >
</head>
<body class="p-4">
<div class="container">
    <h1 class="mb-4">Configuration</h1>
    <form id="config-form">
        <div class="accordion" id="configAccordion"></div>
        <button type="submit" class="btn btn-primary mt-3">Save</button>
    </form>
</div>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<!-- Tagify JS -->
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		fetch('config-schema.json')
			.then(res => res.json())
			.then(schema => {
				const accordion = document.getElementById('configAccordion');

				// Recursive renderer for sections
				function renderSection(sec, indexPath = []) {
					const wrapper = document.createElement('div');
					wrapper.className = 'accordion-item';
					const idSuffix = indexPath.join('_');

					// Header
					const header = document.createElement('h2');
					header.className = 'accordion-header';
					header.id = `heading_${idSuffix}`;
					const btn = document.createElement('button');
					btn.className = 'accordion-button collapsed';
					btn.type = 'button';
					btn.setAttribute('data-bs-toggle', 'collapse');
					btn.setAttribute('data-bs-target', `#collapse_${idSuffix}`);
					btn.setAttribute('aria-expanded', 'false');
					btn.setAttribute('aria-controls', `collapse_${idSuffix}`);
					btn.innerText = sec.title;
					header.appendChild(btn);
					wrapper.appendChild(header);

					// Body
					const collapse = document.createElement('div');
					collapse.id = `collapse_${idSuffix}`;
					collapse.className = 'accordion-collapse collapse';
					collapse.setAttribute('aria-labelledby', `heading_${idSuffix}`);
					collapse.setAttribute('data-bs-parent', '#configAccordion');
					const body = document.createElement('div');
					body.className = 'accordion-body';

					// Fields
					sec.fields.forEach(field => {
						const row = document.createElement('div');
						row.className = 'mb-3 row align-items-center';

						const label = document.createElement('label');
						label.className = 'col-sm-3 col-form-label';
						label.htmlFor = field.name;
						label.innerText = field.label;

						const col = document.createElement('div');
						col.className = 'col-sm-9';

						let input;
						switch (field.type) {
							case 'checkbox':
								input = document.createElement('input');
								input.type = 'checkbox';
								input.className = 'form-check-input';
								input.id = field.name;
								input.name = field.name;
								if (field.value === 'true') input.checked = true;
								break;

							case 'number':
								input = document.createElement('input');
								input.type = 'number';
								input.className = 'form-control';
								input.id = field.name;
								input.name = field.name;
								input.value = field.value;
								break;

							case 'select':
								input = document.createElement('select');
								input.className = 'form-select';
								input.id = field.name;
								input.name = field.name;
								field.options.forEach(opt => {
									const o = document.createElement('option');
									o.value = opt.value;
									o.innerText = opt.label;
									if (field.value === opt.value) o.selected = true;
									input.appendChild(o);
								});
								break;

							default:
								input = document.createElement('input');
								input.type = 'text';
								input.className = 'form-control tag-input';
								input.id = field.name;
								input.name = field.name;
								input.value = field.value;
						}

						col.appendChild(input);
						row.appendChild(label);
						row.appendChild(col);
						body.appendChild(row);
					});

					// Subsections (might be missing if there are none)
                   (sec.subsections || []).forEach((sub, idx) => {
                     const child = renderSection(sub, indexPath.concat(idx));
                     body.appendChild(child);
                   });

					collapse.appendChild(body);
					wrapper.appendChild(collapse);
					return wrapper;
				}

				// Build all topâ€‘level sections
                console.log(schema);
				schema.sections.forEach((sect, idx) => {
					const sectionNode = renderSection(sect, [idx]);
					accordion.appendChild(sectionNode);
				});

				// Initialize Tagify for array inputs
				document.querySelectorAll('input.tag-input').forEach(el => {
					new Tagify(el, { delimiters: ', ', dropdown: { enabled: 0 } });
				});
			})
			.catch(console.error);

		// Prevent default submit and log serialized form
		document.getElementById('config-form').addEventListener('submit', e => {
			e.preventDefault();
			const data = {};
			new FormData(e.target).forEach((v, k) => { data[k] = v; });
			console.log('Form submission payload:', data);
			// TODO: POST to your server endpoint
		});
	});
</script>
</body>
</html>
